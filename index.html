<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙˆÙ„Ø¯ ÙˆÙ…Ø³Ø­ QR Ù…Ø´ÙØ±</title>
 <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
 <link rel="shortcut icon" href="undefined.jpg" type="image/x-icon">
<style>
body {
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    background: linear-gradient(to bottom right, #071e35, #649aec);
    min-height: 100vh;
    padding: 20px;
}
h2 { color: #0380fd; text-shadow: 1px 3px 5px rgba(0, 0, 0, 0.986); }
input, button {
    padding: 12px;
    width: 80%;
    margin: 8px;
    border-radius: 12px;
    border: none;
    font-size: 16px;
}
button {
    background: #2270be;
    color: rgb(252, 251, 251);
    cursor: pointer;
    transition: 0.3s;
}
button:hover { background: #03509c; transform: scale(1.05); }
#qrcode { margin: 20px auto; }
#decrypted { margin-top: 20px; font-weight: bold; color: #04386b; }
#cameraContainer { display: none; margin-top: 20px; }
video {
    width: 320px; height: 240px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<h2>ğŸ” Ù…ÙˆÙ„Ø¯ ÙˆÙ…Ø³Ø­ QR Ù…Ø´ÙØ±</h2>

<input type="text" id="linkInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù„ÙŠÙ†Ùƒ Ù‡Ù†Ø§">
<br>
<button onclick="generateQR()">Ø¥Ù†Ø´Ø§Ø¡ QR Ù…Ø´ÙØ±</button>
<button onclick="downloadQR()">ØªØ­Ù…ÙŠÙ„ QR</button>
<button onclick="openLink()">ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
<button onclick="uploadImage()">ğŸ“ Ø±ÙØ¹ ØµÙˆØ±Ø© QR</button>
<button onclick="scanCamera()">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
<button onclick="stopCamera()">âŒ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>

<canvas id="qrcode"></canvas>

<div id="cameraContainer">
  <video id="camera" autoplay></video>
  <canvas id="cameraCanvas" width="320" height="240" style="display:none;"></canvas>
</div>

<p id="decrypted"></p>

<script>
const secretKey = "BassemSecret123";
let currentLink = "";
let currentCiphertext = "";
let cameraStream = null;
let scanInterval = null;

// ØªÙˆÙ„ÙŠØ¯ QR
function generateQR() {
  const link = document.getElementById("linkInput").value;
  if(!link) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù„ÙŠÙ†Ùƒ Ø£ÙˆÙ„Ø§Ù‹!");
  currentLink = link;
  currentCiphertext = CryptoJS.AES.encrypt(link, secretKey).toString();
  QRCode.toCanvas(document.getElementById("qrcode"), currentCiphertext, { width: 250 });
  document.getElementById("decrypted").innerText = "";
}

// ØªØ­Ù…ÙŠÙ„ QR
function downloadQR() {
  const canvas = document.getElementById("qrcode");
  if(!canvas) return alert("Ø£Ù†Ø´Ø¦ QR Ø£ÙˆÙ„Ø§Ù‹!");
  const link = document.createElement("a");
  link.download = "qr_code.png";
  link.href = canvas.toDataURL();
  link.click();
}

// ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·
function openLink() {
  if(!currentLink) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ø­Ø§Ù„ÙŠØ§Ù‹!");
  window.open(currentLink, "_blank");
}

// Ø±ÙØ¹ ØµÙˆØ±Ø© QR Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²
function uploadImage() {
  stopCamera();
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function() {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        decodeQR(imageData);
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  };
  fileInput.click();
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
function scanCamera() {
  stopCamera();
  const video = document.getElementById("camera");
  const container = document.getElementById("cameraContainer");
  const canvas = document.getElementById("cameraCanvas");
  const ctx = canvas.getContext("2d");

  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      cameraStream = stream;
      video.srcObject = stream;
      container.style.display = "block";

      scanInterval = setInterval(() => {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          decodeText(code.data);
        }
      }, 500);
    })
    .catch(err => alert("ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err));
}

// Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  if (scanInterval) clearInterval(scanInterval);
  document.getElementById("cameraContainer").style.display = "none";
}

// ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ù†Øµ
function decodeText(text) {
  try {
    const bytes = CryptoJS.AES.decrypt(text, secretKey);
    const originalLink = bytes.toString(CryptoJS.enc.Utf8);
    if (originalLink) {
      document.getElementById("decrypted").innerText = "ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: " + originalLink;
      window.open(originalLink, "_blank");
      stopCamera();
    }
  } catch {
    document.getElementById("decrypted").innerText = "ÙØ´Ù„ ÙÙŠ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±!";
  }
}

// ÙÙƒ QR Ù…Ù† ØµÙˆØ±Ø©
function decodeQR(imageData) {
  const code = jsQR(imageData.data, imageData.width, imageData.height);
  if (code) decodeText(code.data);
  else document.getElementById("decrypted").innerText = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ QR ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©!";
}
</script>
</body>
</html>
